# AIエージェント運用ガイドライン (AGENTS.md)

このプロジェクト (`dsx`) におけるAIエージェント（GitHub Copilot等）の使用、および開発成果物に関する言語規定です。
本プロジェクトでは、開発者（ユーザー）にとっての認知負荷を最小限にするため、徹底した日本語化を求めます。

## 1. 言語規定：日本語の義務化

**全てのコミュニケーション、ドキュメント、およびユーザーインターフェース（UI）において「日本語」を使用することを義務付けます。**

### コミュニケーション (AI応答)
* AIからの応答、質問、提案は全て**日本語**で行ってください。
* 技術的な専門用語についても、可能な限り日本語での補足説明を加えるか、文脈に沿った自然な日本語表現を用いてください。
* 英語のドキュメントやリソースを参照した場合でも、その内容の要約や説明は必ず**日本語**で行ってください。

### 開発成果物 (UI/UX)
* **CLI/TUIの出力メッセージ**: 
  * ユーザーに表示される全てのテキスト（情報ログ、警告、エラー、入力プロンプト）は**日本語**で実装してください。
  * 英語のままのエラーメッセージをそのまま表示せず、可能な限り日本語で意味がわかるように翻訳・ラップしてください。
* **対話型インターフェース**: 
  * `survey` や `Bubble Tea` 等で実装するウィザード画面、選択肢、ヘルプテキストは全て**日本語**で設計してください。

### コード・ドキュメント
* **コード内コメント**: 
  * ロジックの説明、関数のdocコメントなどは**日本語**で記述してください。
* **ドキュメント**: 
  * `README.md`、`Implementation_Plan.md` 等のプロジェクトドキュメントは**日本語**を正として記述・更新してください。

## 2. プロジェクトのコンテキスト

このツールは日本人開発者が日々の開発環境維持（リポジトリ管理、システム更新、環境変数注入）を行うために使用するものです。
したがって、将来的な国際化（i18n）対応を考慮するよりも、**現在のユーザーにとっての直感的な使いやすさ（日本語ネイティブな体験）** を最優先事項とします。

## 3. ドキュメント運用・参照ルール

開発を進める際は、以下のドキュメントを常に参照・更新してください。

*   **`tasks.md` (進捗管理)**:
    *   開発セッションの開始時に現在のタスクを確認してください。
    *   実装が完了したら、必ず該当項目のチェックボックス (`[x]`) を更新してください。
    *   新たなタスクが発生した場合は、適宜リストに追加してください。

*   **`docs/Implementation_Plan.md` (実装計画)**:
    *   プロジェクト全体のロードマップやアーキテクチャ設計のマスタードキュメントです。
    *   設計上の判断が必要な場合は、このドキュメントの「目的」「設計指針」に立ち返ってください。

*   **`docs/Legacy_Migration_Analysis.md` (移行要件)**:
    *   旧ツール (`sysup`, `Setup-Repository`) の機能仕様や移行方針が定義されています。
    *   「システム更新 (`sys`)」や「リポジトリ管理 (`repo`)」の実装詳細を検討する際は、必ずこのドキュメントを確認してください。

## 4. 実装ルール
*   **一貫性の維持**:
    *   既存のコードスタイル、命名規則、設計パターンに従って実装してください。
    *   新たなライブラリやフレームワークを導入する場合は、事前にドキュメントでその理由と影響範囲を明確にしてください。
*   **こまめなコミット**:
    *   セッション終了時は、必ずコードをコミットしてください。
    *   変更内容は小さく、意味のある単位でコミットしてください。
    *   コミットメッセージは日本語で、変更内容が一目でわかるように記述してください。
*   **mainブランチへの直接コミットの禁止**:
    *   直接 `main` ブランチにコミットすることは禁止します。
    *   変更は必ず新しいブランチを作成し、プルリクエスト（PR）を通じてレビュー・マージしてください。
    *   PRの説明も日本語で記述し、変更内容と目的を明確にしてください。

## 5. テスト方針：カバレッジより性質を重視

**カバレッジ数値は重要ですが、AIが取り繕いやすい指標でもあります。**
むしろ「どんなテストを書くか」を明確に指定することで品質を担保します。

### 必須原則

| 原則 | 説明 |
|------|------|
| **Table-driven tests を基本** | Goの慣習に従い、テストケースをテーブル形式で定義する。入力・期待値・説明を明確に |
| **境界値テスト必須** | 空文字列、nil、0、最大値、負数などエッジケースを必ず含める |
| **失敗系（エラー）が本体** | 正常系より異常系を重視。「何が失敗すべきか」を明確にテストする |
| **"失敗するべきケースが失敗する"** | エラーが返るべき状況でエラーが返ることを確認（false positiveの防止） |
| **モックより fake / in-memory を優先** | 過剰なモック地獄を回避。実際の動作に近いテストを心がける |
| **回帰テスト重視** | バグ発見時は「バグ再現→修正→テスト固定」のサイクルを守る |

### テストコード例（Table-driven）

```go
func TestIsValidEnvVarName(t *testing.T) {
    tests := []struct {
        name     string
        input    string
        expected bool
    }{
        // 正常系
        {"通常の変数名", "MY_VAR", true},
        {"数字を含む", "VAR_123", true},
        
        // 境界値・エッジケース
        {"空文字列", "", false},
        {"数字始まり", "123_VAR", false},
        {"ハイフン含む", "MY-VAR", false},
        
        // 失敗系が本体
        {"スペース含む", "MY VAR", false},
        {"日本語", "変数", false},
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            got := IsValidEnvVarName(tt.input)
            if got != tt.expected {
                t.Errorf("IsValidEnvVarName(%q) = %v, want %v", tt.input, got, tt.expected)
            }
        })
    }
}
```

### 禁止事項
- **カバレッジ稼ぎのための形骸化したテスト**（意味のないアサーション）
- **過剰なモック**（実装詳細への依存を生む）
- **正常系のみのテスト**（異常系を無視した楽観的テスト）

## 6. イテレーション終了時のチェックリスト（必須）

**各機能実装やタスク完了時には、以下の項目を必ず実施してください。**

### コードレビューと改善
- [ ] 実装したコードを見直し、リファクタリングの余地がないか確認
- [ ] 不要なコメント、デバッグコード、TODO の整理
- [ ] エラーハンドリングが適切か確認
- [ ] 日本語メッセージが統一されているか確認

### テスト
- [ ] 新規実装に対してテストケースが必要か判断
- [ ] **Table-driven tests** で実装されているか確認
- [ ] **境界値・エラー系**が網羅されているか確認
- [ ] `task test` を実行し、全テストがパスすることを確認
- [ ] 既存テストが壊れていないことを確認

### ドキュメント更新（必須）
以下のドキュメントを実装内容に合わせて更新してください：

| ドキュメント | 更新内容 |
|-------------|---------|
| `CHANGELOG.md` | 新機能・修正・破壊的変更を記録 |
| `README.md` | 使用方法・コマンド一覧を最新化 |
| `tasks.md` | 完了タスクにチェック、新規タスクを追加 |

### 最終確認
- [ ] `go build ./...` が成功すること
- [ ] `dsx --help` が正しく表示されること
- [ ] 変更内容をコミット＆プッシュ

---
*このファイルはプロジェクトのルートに配置し、以後のセッションでAIエージェントがコンテキストとして常に参照すべき指針とします。*
